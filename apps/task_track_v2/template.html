<!--
# TODO

- Have day markers even if no data.

-->

<!DOCTYPE html>
<meta charset="utf-8">
<style>

.chart rect {
}

.chart text {
}

</style>
<body>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="data.js"></script>
<script>

// @@TODO: be able to say: 'want from 2015-08 to 2015-09'. Generate reports by months.
//         ^^ maybe this would be easier in python, then just create linkable html files.
function getUnixTimeXDaysAgoFromNextMidnight(x){
	var d = new Date()
	d.setHours( 24 );
	d.setMinutes( 0 );
	d.setSeconds( 0 );
	d.setMilliseconds( 0 );
	d.setDate(d.getDate() - x)
	d = Math.floor(d.getTime()/1000)
	return d
}

function getUnixTimeAtSeparation(){
	// I work until ~3-4am sometimes, make the day split there :).
	var d = new Date()
	d.setHours( 28 );
	d.setMinutes( 0 );
	d.setSeconds( 0 );
	d.setMilliseconds( 0 );
	d = Math.floor(d.getTime()/1000)
	return d
}

// @@ review currying.
function onEach(x, fn){ for(var i = 0; i < x.length; ++i){ fn(x[i]) } }

function dataToBuckets(data, timePeriodInDays, min, max){
	// var max = 0; onEach(data, function(x){ if(max < x.date){max=x.date} })
	// var min = max; onEach(data, function(x){ if(min > x.date){min=x.date} })

	var step = (max-min)/timePeriodInDays

	dataT = []
	for(var i = 0; i < timePeriodInDays; ++i){
		var o = new Object()
		o.date = i*step
		o.length = 0
		dataT.push(o)
	}

	onEach(data, function(x){
		var ii = Math.floor(timePeriodInDays*(x.date - min)/(max-min))
		if(ii == timePeriodInDays){ ii -= 1 }
		dataT[ii].length += x.length
	})

	return dataT
}

function genChart(data, timePeriodInDays, activityFilter){

	// Only keep cs events...
	if(activityFilter != null){
		data = data.filter(function(d){return d.type == activityFilter})
	}
	// ... of the last timePeriodInDays days.
	data = data.filter(function(d){return d.date >= getUnixTimeXDaysAgoFromNextMidnight(timePeriodInDays)})

	data = dataToBuckets(data, timePeriodInDays, getUnixTimeXDaysAgoFromNextMidnight(timePeriodInDays), getUnixTimeAtSeparation())

	var width = 1000 
	var barWidth = width / (timePeriodInDays)

	yMin = 0
	// yMax = d3.max(data.map(function(v){ return v.length }))
	// This is in hours... the REAL solution here would be to have the amount of time max for ALL data.
	yMax = 12

	xMin = d3.min(data.map(function(v){ return v.date }))
	//xMin = getUnixTimeXDaysAgoFromNextMidnight(timePeriodInDays)
	//xMin = 0
	xMax = d3.max(data.map(function(v){ return v.date }))

	var height = 70 
	d3.select("body").append("p").text("Activity: " + activityFilter)
	var chart = d3.select("body")
	    .append("svg:svg")
	    .attr("width", width)
	    .attr("height", height)
	
	var xScale = d3.scale.linear()
		.domain([xMin, xMax])
		.range([0, width-barWidth])

	var bar = chart.selectAll("nothing_yet") // By default, selecting something that does no exist returns an empty set.
	    .data(data) // ... for each data point ...
	    .enter().append("g")
	    // Here 'd' is the data, 'i' is the position of the data in the array.
	    // .attr("transform", function(d, i) { return "translate(" + xScale(d.date) + ", 0)" });

	var yScale = d3.scale.linear()
		.domain([yMin, yMax])
		.range([0, 100])

	bar.append("rect")
	    .attr("width", barWidth-2)
	    .attr("x", function(d){ return xScale(d.date)})
	    .attr("y", function(d){return height-yScale(d.length)})
	    .attr("height", function(d){return yScale(d.length)})
	    .attr("fill", function(d){
			    var r = 0
			    var g = Math.floor(d.length*30) // RGB function does not like non-int apparently.
			    if(g<=50){g=50}
			    if(g>=200){g=200}
			    var b = 50;
			    return "rgb("+r+", "+g+", "+b+")"
			    })

	var txtSize = barWidth*0.5
	if (txtSize > 18){txtSize = 18}

	chart.selectAll("nothing_here")
		   .data(data)
		   .enter()
		   .append("text")
		   .text(function(d, i) {
				   return Math.floor(10*d.length)/10
		   })
		   .attr("x", function(d, i) {
				   return xScale(d.date) + barWidth/2
		   })
		   .attr("y", function(d, i) {
				   return txtSize
		   })
		   .attr("font-family", "sans-serif")
		   .attr("font-size", txtSize + "px")
		   .attr("fill", "black")
		   .attr("text-anchor", "middle")

	var totalWorked = 0
	for(var i = 0; i < data.length; ++i){
		totalWorked += data[i].length
	}
	

	hoursPerDay = Math.floor(10*totalWorked/timePeriodInDays)/10
	d3.select("body").append("p").text("You have worked " + Math.floor(10*totalWorked)/10 + " hour(s) in " + timePeriodInDays + " days, or " + hoursPerDay + " hour(s) per day.")
}

genChart(data, 7, "cs")
genChart(data, 30, "cs")
genChart(data, 60, "cs")
genChart(data, 90, "cs")
genChart(data, 180, "cs")

genChart(data, 7, "medi")
genChart(data, 60, "medi")
</script>
<body>
</body>

