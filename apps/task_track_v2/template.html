<!DOCTYPE html>
<meta charset="utf-8">
<style>

.chart rect {
}

.chart text {
}

</style>
<body>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="data.js"></script>
<script>

function getUnixTimeXDaysAgo(x){
	var d = new Date()
	d.setDate(d.getDate() - x)
	d = Math.floor(d.getTime()/1000)
	return d
}

function onEach(x, fn){
	for(var i = 0; i < x.length; ++i){
		fn(x[i])
	}
}

function dataToBuckets(data, nBuckets){
	var min = 1000000000000; onEach(data, function(x){ if(min > x.date){min=x.date} })
	var max = 0; onEach(data, function(x){ if(max < x.date){max=x.date} })

	var step = (max-min)/nBuckets

	dataT = []
	for(var i = 0; i < nBuckets; ++i){
		var o = new Object()
		o.date = i*step
		o.length = 0
		dataT.push(o)
	}

	onEach(data, function(x){
		var ii = Math.floor(nBuckets*(x.date - min)/(max-min))
		if(ii == nBuckets){ ii -= 1 }
		dataT[ii].length += x.length
	})

	return dataT
}

function genChart(data, timePeriodInDays){

	// Only keep cs events...
	data = data.filter(function(d){return d.type == "cs"})
	// ... of the last timePeriodInDays days.
	data = data.filter(function(d){return d.date >= getUnixTimeXDaysAgo(timePeriodInDays)})

	data = dataToBuckets(data, timePeriodInDays)

	var width = 1000 
	var barWidth = width / (timePeriodInDays-1)

	yMin = 0
	yMax = d3.max(data.map(function(v){ return v.length }))
	xMin = d3.min(data.map(function(v){ return v.date }))
	xMax = d3.max(data.map(function(v){ return v.date }))
	var height = 100

	var chart = d3.select("body")
	    .append("svg:svg")
	    .attr("width", width)
	    .attr("height", height)
	
	var xScale = d3.scale.linear()
		.domain([xMin, xMax])
		.range([0, width])

	var bar = chart.selectAll("nothing_yet") // By default, selecting something that does no exist returns an empty set.
	    .data(data) // ... for each data point ...
	    .enter().append("g")
	    // Here 'd' is the data, 'i' is the position of the data in the array.
	    .attr("transform", function(d, i) { return "translate(" + xScale(d.date) + ", 0)" });

	var yScale = d3.scale.linear()
		.domain([yMin, yMax])
		.range([0, 100])

	bar.append("rect")
	    .attr("width", barWidth-2)
	    .attr("y", function(d){return height-yScale(d.length)})
	    .attr("height", function(d){return yScale(d.length)})
	    .attr("fill", function(d){
			    var r = 0
			    var g = d.length*50
			    if(g<=75){g=75}
			    if(g>=255){g=200}
			    var b = 50
			    return "rgb("+r+", "+g+", "+b+")"
			    })

	var totalWorked = 0
	for(var i = 0; i < data.length; ++i){
		totalWorked += data[i].length
	}

	hoursPerDay = Math.floor(100*totalWorked/timePeriodInDays)/100
	d3.select("body").append("p").text("You have worked " + totalWorked + " hour(s) in " + timePeriodInDays + " days, or " + hoursPerDay + " hour(s) per day.")
}

genChart(data, 7)
genChart(data, 30)
genChart(data, 90)
</script>
<body>
</body>
